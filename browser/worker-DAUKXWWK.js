function _(r,s){let l=s||r,f=s?r:0,i=[];for(let p=f;p<l;p++)i.push(p);return i}function v(r){for(let s=r.length-1;s>0;s--){let l=Math.floor(Math.random()*s),f=r[l];r[l]=r[s],r[s]=f}return r}function h(r,s){for(let l=0;l<r.length-1;l++)for(let f=l+1;f<r.length;f++)s(r[l],r[f])}var G=30,R=2,T=100;function z(r){var s,l,f;r.groupSize=(s=r.groupSize)!=null?s:4;let i=r.groupSize*r.groups;function p(e,o){let t=e.map(u=>{let n=0;return h(u,(g,d)=>n+=Math.pow(o[g][d],2)),n});return{groups:e,groupsScores:t,total:t.reduce((u,n)=>u+n,0)}}function m(){let e=v(_(i)),o=[];for(let t=0;t<r.groups;t++){let u=t*r.groupSize;o.push(e.slice(u,u+r.groupSize))}return o}function O(e,o){let t=[];return e.forEach(u=>{let d=u.groups.map((c,S)=>({group:c,score:u.groupsScores[S]})).sort((c,S)=>S.score-c.score).map(c=>c.group);t.push(u);for(let c=0;c<r.groupSize;c++)for(let S=r.groupSize;S<i;S++)t.push(p(N(d,c,S),o));for(let c=0;c<R;c++)t.push(p(m(),o))}),t}function A(e,o){e.forEach(t=>h(t,(u,n)=>{let g=o[u][n]+1;o[u][n]=g,o[n][u]=g}))}function N(e,o,t){let u=JSON.parse(JSON.stringify(e)),n=r.groupSize;return u[Math.floor(o/n)][o%n]=e[Math.floor(t/n)][t%n],u[Math.floor(t/n)][t%n]=e[Math.floor(o/n)][o%n],u}let a=[];for(let e=0;e<i;e++)a[e]=Array(i).fill(0);(l=r.forbidGroups)==null||l.forEach(e=>{h(e,(o,t)=>{a[o][t]=a[t][o]=1/0})}),(f=r.avoidGroups)==null||f.forEach(e=>{h(e,(o,t)=>{a[o][t]=a[t][o]=a[o][t]+1})});let E=[],M=[];for(let e=0;e<r.numberOfRounds;e++){let o=Array(5).fill(0).map(()=>p(m(),a)),t=0;for(;o[0].total>0&&t<G;){o=O(o,a).sort((d,c)=>d.total-c.total);let g=o[0].total;o=o.slice(0,o.findIndex(d=>d.total>g)),o=v(o).slice(0,T),t++}let u=o[0];E.push(u.groups),M.push(u.groupsScores),A(u.groups,a)}return{rounds:E,roundScores:M,map:a}}addEventListener("message",({data:r})=>{let s=z(r);postMessage(s)});
